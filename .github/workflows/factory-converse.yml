name: "Factory: Conversation"

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: factory-converse-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  converse:
    # Anti-loop guards (5-layer):
    # 1. Not a bot comment (author check)
    # 2. Comment body doesn't start with bot marker (redundant safety)
    # 3. Issue has factory label OR comment mentions @factory
    if: >-
      github.event.comment.user.login != 'github-actions[bot]' &&
      !startsWith(github.event.comment.body, '<!-- factory:bot -->') &&
      (
        contains(github.event.issue.labels.*.name, 'factory:refining') ||
        contains(github.event.issue.labels.*.name, 'factory:ready') ||
        contains(github.event.issue.labels.*.name, 'factory:decision') ||
        contains(github.event.comment.body, '@factory')
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for APPROVE command
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          ISSUE_NUM=${{ github.event.issue.number }}

          if echo "$COMMENT_BODY" | grep -qiP '^\s*APPROVE\s*$'; then
            LABELS=$(gh issue view "$ISSUE_NUM" --json labels -q '.labels[].name' | tr '\n' ',')
            if echo "$LABELS" | grep -q "factory:ready"; then
              echo "action=approve" >> "$GITHUB_OUTPUT"
            else
              echo "action=converse" >> "$GITHUB_OUTPUT"
              echo "Spec not ready yet. Treating as regular comment."
            fi
          else
            echo "action=converse" >> "$GITHUB_OUTPUT"
          fi

      - name: Handle APPROVE
        if: steps.check.outputs.action == 'approve'
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          gh issue edit "$ISSUE_NUM" --remove-label "factory:ready"
          gh issue edit "$ISSUE_NUM" --add-label "factory:approved"
          gh issue comment "$ISSUE_NUM" \
            --body "<!-- factory:bot -->
          Approved! Starting the Factory pipeline now. I'll update this issue with progress."

      - name: Collect context
        if: steps.check.outputs.action == 'converse'
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          LABELS=$(gh issue view "$ISSUE_NUM" --json labels -q '.labels[].name' | tr '\n' ',')

          # Count bot turns
          COMMENTS=$(gh issue view "$ISSUE_NUM" --json comments -q '.comments[].body')
          BOT_TURNS=$(echo "$COMMENTS" | grep -c '<!-- factory:bot -->' || echo "0")
          echo "bot_turns=${BOT_TURNS}" >> "$GITHUB_OUTPUT"

          # Detect request type
          if echo "$LABELS" | grep -q "type:improvement"; then
            echo "type=improvement" >> "$GITHUB_OUTPUT"
          else
            echo "type=new-service" >> "$GITHUB_OUTPUT"
          fi

          # Check if this is a decision sub-issue response
          if echo "$LABELS" | grep -q "factory:decision"; then
            echo "is_decision=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_decision=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Continue conversation
        if: steps.check.outputs.action == 'converse'
        id: respond
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.FACTORY_GH_PAT }}
          trigger_phrase: "@factory"
          label_trigger: "factory:refining"
          prompt: |
            You are the Factory Bot continuing a spec refinement conversation.

            Request type: ${{ steps.context.outputs.type }}
            Bot turns so far: ${{ steps.context.outputs.bot_turns }}
            Is decision sub-issue: ${{ steps.context.outputs.is_decision }}

            Read templates/prompts/converse.md for conversation guidance and spec YAML format.

            ${{ steps.context.outputs.bot_turns >= 3 && 'IMPORTANT: You have already asked enough questions. You MUST generate the spec YAML now, using reasonable defaults for any remaining unknowns. Do not ask more questions.' || '' }}
            ${{ steps.context.outputs.is_decision == 'true' && 'This is a DECISION sub-issue. The human has answered a question that was blocking a worker. Summarize the decision and state the resolution clearly.' || '' }}

            IMPORTANT: Start your response with '<!-- factory:bot -->' on the first line.
            If generating a spec YAML, include the '<!-- factory:spec -->' marker before the YAML code block.
          claude_args: "--allowedTools Read"

      - name: Check for spec generation
        if: steps.check.outputs.action == 'converse'
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          # Check latest comment for spec marker
          LATEST_COMMENT=$(gh issue view "$ISSUE_NUM" --json comments -q '.comments[-1].body')
          if echo "$LATEST_COMMENT" | grep -q '<!-- factory:spec -->'; then
            gh issue edit "$ISSUE_NUM" --add-label "factory:ready"
            echo "Spec generated! Issue marked as ready for approval."
          fi

      - name: Handle decision sub-issue resolution
        if: steps.check.outputs.action == 'converse' && steps.context.outputs.is_decision == 'true'
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          ISSUE_BODY=$(gh issue view "$ISSUE_NUM" --json body -q .body)

          PARENT_NUM=$(echo "$ISSUE_BODY" | grep -oP 'Parent:\s*#(\d+)' | grep -oP '\d+' | head -1)

          if [ -n "$PARENT_NUM" ]; then
            gh issue comment "$PARENT_NUM" \
              --body "<!-- factory:bot -->
          Decision resolved in #${ISSUE_NUM}. Resuming pipeline."

            gh issue edit "$PARENT_NUM" --remove-label "factory:blocked" 2>/dev/null || true
          fi

          gh issue close "$ISSUE_NUM" --comment "<!-- factory:bot -->
          Decision recorded. Closing sub-issue."
