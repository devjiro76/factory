name: "Factory: Triage"

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: factory-triage-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  triage:
    if: contains(github.event.issue.labels.*.name, 'factory:triage')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect request type
        id: parse
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          LABELS=$(gh issue view "$ISSUE_NUM" --json labels -q '.labels[].name' | tr '\n' ',')
          if echo "$LABELS" | grep -q "type:improvement"; then
            echo "type=improvement" >> "$GITHUB_OUTPUT"
          else
            echo "type=new-service" >> "$GITHUB_OUTPUT"
          fi

      - name: Analyze existing codebase (improvement only)
        if: steps.parse.outputs.type == 'improvement'
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_BODY=$(gh issue view "${{ github.event.issue.number }}" --json body -q .body)
          TARGET_REPO=$(echo "$ISSUE_BODY" | grep -oP '[A-Za-z0-9_-]+/[a-z0-9][a-z0-9_-]+' | head -1)
          if [ -z "$TARGET_REPO" ]; then
            echo "CODEBASE_SUMMARY=Could not determine target repo from issue." >> "$GITHUB_ENV"
            exit 0
          fi

          echo "Cloning ${TARGET_REPO} for analysis..."
          gh repo clone "${TARGET_REPO}" /tmp/target-repo 2>/dev/null || {
            echo "CODEBASE_SUMMARY=Could not clone ${TARGET_REPO}. Repository may not exist." >> "$GITHUB_ENV"
            exit 0
          }

          cd /tmp/target-repo
          SUMMARY="### Repository: ${TARGET_REPO}\n\n"
          SUMMARY+="#### File Structure\n\`\`\`\n"
          SUMMARY+="$(find . -type f -not -path './.git/*' -not -path './node_modules/*' -not -path './dist/*' | sort | head -50)\n"
          SUMMARY+="\`\`\`\n\n"

          if [ -f package.json ]; then
            SUMMARY+="#### package.json (key fields)\n\`\`\`json\n"
            SUMMARY+="$(cat package.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps({k:d.get(k) for k in ['name','scripts','dependencies','devDependencies'] if k in d}, indent=2))" 2>/dev/null || cat package.json)\n"
            SUMMARY+="\`\`\`\n"
          fi

          echo "CODEBASE_SUMMARY<<CODEBASE_EOF" >> "$GITHUB_ENV"
          echo -e "$SUMMARY" | head -100 >> "$GITHUB_ENV"
          echo "CODEBASE_EOF" >> "$GITHUB_ENV"

      - name: Run triage analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.FACTORY_GH_PAT }}
          trigger_phrase: "factory:triage"
          label_trigger: "factory:triage"
          prompt: |
            You are the Factory Bot performing initial triage on this issue.
            Request type: ${{ steps.parse.outputs.type }}

            Read the appropriate prompt template for guidance:
            - New service: templates/prompts/triage-new.md
            - Improvement: templates/prompts/triage-improvement.md

            Codebase analysis (for improvements):
            ${{ env.CODEBASE_SUMMARY }}

            IMPORTANT: Start your response with '<!-- factory:bot -->' on the first line.
            Ask 2-4 focused questions to clarify the spec. Be concise and friendly.
          claude_args: "--allowedTools Read"

      - name: Transition labels
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          gh issue edit "${{ github.event.issue.number }}" --remove-label "factory:triage"
          gh issue edit "${{ github.event.issue.number }}" --add-label "factory:refining"

      - name: Report triage failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          gh issue comment "$ISSUE_NUM" \
            --body "<!-- factory:bot -->
          Sorry, I encountered an error during triage. Please check the [workflow run](${RUN_URL}) for details.

          A maintainer will review this shortly."
