name: "Factory: Triage"

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write

concurrency:
  group: factory-triage-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  triage:
    if: contains(github.event.issue.labels.*.name, 'factory:triage')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Parse issue body
        id: parse
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          ISSUE_BODY=$(gh issue view "$ISSUE_NUM" --json body -q .body)
          echo "${ISSUE_BODY}" > /tmp/issue-body.txt

          # Detect request type
          LABELS=$(gh issue view "$ISSUE_NUM" --json labels -q '.labels[].name' | tr '\n' ',')
          if echo "$LABELS" | grep -q "type:improvement"; then
            echo "type=improvement" >> "$GITHUB_OUTPUT"
          else
            echo "type=new-service" >> "$GITHUB_OUTPUT"
          fi

      - name: Analyze existing codebase (improvement only)
        if: steps.parse.outputs.type == 'improvement'
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          # Extract target repo from issue body
          TARGET_REPO=$(grep -oP '[A-Za-z0-9_-]+/[a-z0-9][a-z0-9_-]+' /tmp/issue-body.txt | head -1)
          if [ -z "$TARGET_REPO" ]; then
            echo "CODEBASE_SUMMARY=Could not determine target repo from issue." >> "$GITHUB_ENV"
            exit 0
          fi

          echo "Cloning ${TARGET_REPO} for analysis..."
          gh repo clone "${TARGET_REPO}" /tmp/target-repo 2>/dev/null || {
            echo "CODEBASE_SUMMARY=Could not clone ${TARGET_REPO}. Repository may not exist." >> "$GITHUB_ENV"
            exit 0
          }

          # Generate codebase summary
          cd /tmp/target-repo
          SUMMARY="### Repository: ${TARGET_REPO}\n\n"
          SUMMARY+="#### File Structure\n\`\`\`\n"
          SUMMARY+="$(find . -type f -not -path './.git/*' -not -path './node_modules/*' -not -path './dist/*' | sort | head -50)\n"
          SUMMARY+="\`\`\`\n\n"

          if [ -f package.json ]; then
            SUMMARY+="#### package.json (key fields)\n\`\`\`json\n"
            SUMMARY+="$(cat package.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps({k:d.get(k) for k in ['name','scripts','dependencies','devDependencies'] if k in d}, indent=2))" 2>/dev/null || cat package.json)\n"
            SUMMARY+="\`\`\`\n"
          fi

          # Save to env (truncate if too long)
          echo "CODEBASE_SUMMARY<<CODEBASE_EOF" >> "$GITHUB_ENV"
          echo -e "$SUMMARY" | head -100 >> "$GITHUB_ENV"
          echo "CODEBASE_EOF" >> "$GITHUB_ENV"

      - name: Run triage analysis
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          REQUEST_TYPE="${{ steps.parse.outputs.type }}"
          CODEBASE_INFO="${CODEBASE_SUMMARY:-N/A}"

          if [ "$REQUEST_TYPE" = "improvement" ]; then
            PROMPT_TEMPLATE=$(cat templates/prompts/triage-improvement.md)
          else
            PROMPT_TEMPLATE=$(cat templates/prompts/triage-new.md)
          fi

          RESPONSE=$(claude -p "You are the Factory Bot. Analyze this issue and generate the first triage comment.

          Request type: ${REQUEST_TYPE}
          Issue body:
          ${ISSUE_BODY}

          Codebase analysis (for improvements):
          ${CODEBASE_INFO}

          Prompt template for reference:
          ${PROMPT_TEMPLATE}

          Generate ONLY the comment body. Start with '<!-- factory:bot -->' on the first line.
          Ask 2-4 focused questions to clarify the spec. Be concise and friendly." \
            --output-format text \
            --max-turns 5 \
            --dangerously-skip-permissions)

          # Post comment
          gh issue comment "$ISSUE_NUM" --body "$RESPONSE"

          # Transition label: triage â†’ refining
          gh issue edit "$ISSUE_NUM" --remove-label "factory:triage"
          gh issue edit "$ISSUE_NUM" --add-label "factory:refining"

      - name: Report triage failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          gh issue comment "$ISSUE_NUM" \
            --body "<!-- factory:bot -->
          Sorry, I encountered an error during triage. Please check the [workflow run](${RUN_URL}) for details.

          A maintainer will review this shortly."
