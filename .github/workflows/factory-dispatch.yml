name: "Factory: Dispatch"

on:
  workflow_dispatch:
    inputs:
      spec:
        description: "Path to service spec YAML (e.g., specs/pet-chatbot.spec.yaml)"
        required: true
        type: string
  push:
    paths:
      - "specs/**"
    branches:
      - main

permissions:
  contents: read
  actions: write

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine spec path
        id: spec
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "path=${{ inputs.spec }}" >> "$GITHUB_OUTPUT"
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'specs/*.spec.yaml' | head -1)
            if [ -z "$CHANGED" ]; then
              echo "No spec files changed, skipping."
              echo "skip=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "path=$CHANGED" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate spec exists
        if: steps.spec.outputs.skip != 'true'
        run: |
          if [ ! -f "${{ steps.spec.outputs.path }}" ]; then
            echo "::error::Spec file not found: ${{ steps.spec.outputs.path }}"
            exit 1
          fi
          echo "Dispatching factory for: ${{ steps.spec.outputs.path }}"

      - name: Trigger Lead Agent
        if: steps.spec.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run factory-lead.yml \
            --field spec="${{ steps.spec.outputs.path }}"
