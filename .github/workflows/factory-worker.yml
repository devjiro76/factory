name: "Factory: Worker Agent"

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: factory-worker-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  worker:
    if: >-
      github.event.label.name == 'factory:worker-task' ||
      github.event.label.name == 'factory:retry'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Kimi CLI
        run: pip install kimi-cli

      - name: Setup Kimi Subscription Auth
        env:
          KIMI_CONFIG: ${{ secrets.KIMI_CONFIG }}
          KIMI_CREDENTIALS: ${{ secrets.KIMI_CREDENTIALS }}
          KIMI_DEVICE_ID: ${{ secrets.KIMI_DEVICE_ID }}
        run: |
          mkdir -p ~/.kimi/credentials
          echo "${KIMI_CONFIG}" > ~/.kimi/config.toml
          echo "${KIMI_CREDENTIALS}" > ~/.kimi/credentials/kimi-code.json
          echo "${KIMI_DEVICE_ID}" > ~/.kimi/device_id

      - name: Prepare (clear blocked state on retry)
        if: github.event.label.name == 'factory:retry'
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          echo "=== Retry mode: clearing blocked state ==="
          gh issue edit "$ISSUE_NUM" --remove-label "factory:blocked" 2>/dev/null || true
          gh issue edit "$ISSUE_NUM" --remove-label "factory:retry" 2>/dev/null || true
          gh issue comment "$ISSUE_NUM" --body "[factory:worker] Retrying task..."

      - name: Read Issue Body
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_BODY=$(gh issue view ${{ github.event.issue.number }} --json body -q .body)
          ISSUE_TITLE=$(gh issue view ${{ github.event.issue.number }} --json title -q .title)
          echo "title=${ISSUE_TITLE}" >> "$GITHUB_OUTPUT"
          echo "${ISSUE_BODY}" > /tmp/issue-body.txt

      - name: Clone target repo
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          # Extract target repo from issue body (case-insensitive, flexible format)
          TARGET_REPO=$(grep -iP '\*\*Target\s+Repo\*?\*?:?\*?\*?\s*' /tmp/issue-body.txt | grep -oP 'molroo-ai/[a-z0-9_-]+' | head -1)
          if [ -z "$TARGET_REPO" ]; then
            # Fallback: find any molroo-ai/<name> pattern in the body
            TARGET_REPO=$(grep -oP 'molroo-ai/[a-z0-9_-]+' /tmp/issue-body.txt | head -1)
          fi
          if [ -z "$TARGET_REPO" ]; then
            echo "::error::Could not find target repo in issue body"
            exit 1
          fi
          echo "TARGET_REPO=${TARGET_REPO}" >> "$GITHUB_ENV"
          gh repo clone "${TARGET_REPO}" /tmp/target-repo
          cd /tmp/target-repo
          git config user.name "Factory Bot"
          git config user.email "factory@molroo.io"

      - name: Clean up stale branch on retry
        if: github.event.label.name == 'factory:retry'
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          cd /tmp/target-repo
          # Parse branch name from issue body
          BRANCH=$(grep -iP '\*\*Branch\*?\*?:' /tmp/issue-body.txt | head -1 | grep -oP 'factory/[a-z0-9_-]+' | head -1)
          if [ -n "$BRANCH" ]; then
            echo "Cleaning up stale branch: ${BRANCH}"
            git push origin --delete "$BRANCH" 2>/dev/null || echo "Branch ${BRANCH} not on remote, OK."
            # Close stale PR if exists
            STALE_PR=$(gh pr list --repo "$TARGET_REPO" --state open --head "$BRANCH" --json number -q '.[0].number')
            if [ -n "$STALE_PR" ]; then
              gh pr close "$STALE_PR" --repo "$TARGET_REPO" --delete-branch \
                --comment "[factory:worker] Closing stale PR before retry." 2>/dev/null || true
            fi
          fi

      - name: Worker Agent â€” Implement Task
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_BODY=$(cat /tmp/issue-body.txt)

          kimi --print \
            --prompt "You are a Factory Worker Agent. Task issue #${{ github.event.issue.number }}.

          Issue title: ${{ steps.issue.outputs.title }}

          Issue body:
          ${ISSUE_BODY}

          IMPORTANT: You are working in /tmp/target-repo which is the cloned target repo.
          All file paths in the issue are relative to this repo root.

          Instructions:
          1. Read the issue body for file ownership, branch name, and requirements
          2. Create the specified branch: git checkout -b <branch>
          3. Implement ONLY the files listed in 'File Ownership'
          4. If package.json exists, run 'npm install && npm run build'
          5. git add and commit: 'feat: <task description>'
          6. Push: git push origin <branch>
          7. Create PR in the target repo: gh pr create --repo ${TARGET_REPO} --title '[factory] <task>' --body '...' --head <branch> --base main

          CRITICAL: Do NOT modify files outside your file ownership list.
          Read CLAUDE.md in the factory repo (current directory) for SDK patterns." \
            --yolo \
            --work-dir /tmp/target-repo \
            --agent-file ${{ github.workspace }}/agents/worker.yaml \
            --max-steps-per-turn 30

      - name: Report completion
        if: always()
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ job.status }}" = "success" ]; then
            gh issue comment "$ISSUE_NUM" \
              --body "[factory:worker-report] Worker completed. Check ${TARGET_REPO} for PR.
          Run: ${RUN_URL}"
          else
            gh issue comment "$ISSUE_NUM" \
              --body "[factory:worker-report] Worker **failed**. Status: \`${{ job.status }}\`

          **Action required:** Review the error and either:
          1. Fix the issue, then add \`factory:retry\` label to re-run
          2. Or close this issue to skip this task

          Run log: ${RUN_URL}"

            # Add blocked label to signal human attention needed
            gh label create "factory:blocked" --color D93F0B --force 2>/dev/null || true
            gh issue edit "$ISSUE_NUM" --add-label "factory:blocked"
          fi

      - name: Check phase completion & trigger integrator
        if: success()
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          echo "=== Checking if all workers for this phase are done ==="

          # Parse phase and spec from this issue's body
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          PHASE=$(echo "$ISSUE_BODY" | grep -iP '\*\*Phase\*?\*?:' | head -1 | sed 's/.*[*:]\s*//' | awk '{print $1}' | tr -d '`*')
          SPEC=$(echo "$ISSUE_BODY" | grep -iP '\*\*Spec\*?\*?:' | head -1 | sed 's/.*[*:]\s*//' | awk '{print $1}' | tr -d '`*')

          echo "Phase: ${PHASE}"
          echo "Spec: ${SPEC}"

          if [ -z "$PHASE" ] || [ -z "$SPEC" ]; then
            echo "::warning::Could not parse Phase or Spec from issue body. Skipping auto-trigger."
            echo "Issue body (first 500 chars):"
            head -c 500 /tmp/issue-body.txt
            exit 0
          fi

          # Get all open issues with factory:worker-task label
          ISSUE_NUMBERS=$(gh issue list --label "factory:worker-task" --state open --json number -q '.[].number')
          echo "All open worker issues: ${ISSUE_NUMBERS}"

          TOTAL_PHASE_ISSUES=0
          COMPLETED_PHASE_ISSUES=0
          BLOCKED_PHASE_ISSUES=0

          for ISSUE_NUM in $ISSUE_NUMBERS; do
            # Read issue body to check if it belongs to the same phase
            BODY=$(gh issue view "$ISSUE_NUM" --json body -q .body)
            ISSUE_PHASE=$(echo "$BODY" | grep -iP '\*\*Phase\*?\*?:' | head -1 | sed 's/.*[*:]\s*//' | awk '{print $1}' | tr -d '`*')

            if [ "$ISSUE_PHASE" != "$PHASE" ]; then
              continue
            fi

            TOTAL_PHASE_ISSUES=$((TOTAL_PHASE_ISSUES + 1))

            # Check if blocked
            LABELS=$(gh issue view "$ISSUE_NUM" --json labels -q '.labels[].name')
            if echo "$LABELS" | grep -q "factory:blocked"; then
              BLOCKED_PHASE_ISSUES=$((BLOCKED_PHASE_ISSUES + 1))
              continue
            fi

            # Check if this issue has a "Worker completed" comment
            COMPLETED=$(gh issue view "$ISSUE_NUM" --json comments -q '.comments[].body' | grep -c '\[factory:worker-report\] Worker completed' || true)
            if [ "$COMPLETED" -gt 0 ]; then
              COMPLETED_PHASE_ISSUES=$((COMPLETED_PHASE_ISSUES + 1))
            fi
          done

          echo "Phase '${PHASE}': ${COMPLETED_PHASE_ISSUES} completed, ${BLOCKED_PHASE_ISSUES} blocked, ${TOTAL_PHASE_ISSUES} total"

          if [ "$TOTAL_PHASE_ISSUES" -eq 0 ]; then
            echo "::warning::No issues found for phase '${PHASE}'"
            exit 0
          fi

          if [ "$BLOCKED_PHASE_ISSUES" -gt 0 ]; then
            echo "::warning::${BLOCKED_PHASE_ISSUES} worker(s) blocked. Cannot proceed until resolved."
            exit 0
          fi

          if [ "$COMPLETED_PHASE_ISSUES" -lt "$TOTAL_PHASE_ISSUES" ]; then
            echo "Not all workers done yet. Waiting for others."
            exit 0
          fi

          echo "=== All workers done! Triggering Integrator ==="

          # Collect PR numbers from target repo
          TARGET_REPO=$(echo "$ISSUE_BODY" | grep -oP 'molroo-ai/[a-z0-9_-]+' | head -1)
          PRS=$(gh pr list --repo "$TARGET_REPO" --state open --json number,title -q '.[] | select(.title | startswith("[factory]")) | .number' | tr '\n' ',' | sed 's/,$//')
          echo "PRs to integrate: ${PRS}"

          if [ -z "$PRS" ]; then
            echo "::warning::No open factory PRs found in ${TARGET_REPO}"
            exit 0
          fi

          gh workflow run factory-integrator.yml \
            --field spec="$SPEC" \
            --field phase="$PHASE" \
            --field prs="$PRS"

          echo "Integrator triggered for phase=${PHASE}, prs=${PRS}"
