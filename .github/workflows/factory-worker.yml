name: "Factory: Worker Agent"

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: factory-worker-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  worker:
    if: >-
      github.event.label.name == 'factory:worker-task' ||
      github.event.label.name == 'factory:retry'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: React to issue (working on it)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -f content=eyes --silent
          gh issue comment "${{ github.event.issue.number }}" \
            --body "<!-- factory:bot -->
          ðŸ”„ Worker starting..."

      - name: Prepare (clear blocked state on retry)
        if: github.event.label.name == 'factory:retry'
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          echo "=== Retry mode: clearing blocked state ==="
          gh issue edit "$ISSUE_NUM" --remove-label "factory:blocked" 2>/dev/null || true
          gh issue edit "$ISSUE_NUM" --remove-label "factory:retry" 2>/dev/null || true
          gh issue comment "$ISSUE_NUM" --body "[factory:worker] Retrying task..."

      - name: Read Issue Body
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_BODY=$(gh issue view ${{ github.event.issue.number }} --json body -q .body)
          ISSUE_TITLE=$(gh issue view ${{ github.event.issue.number }} --json title -q .title)
          echo "title=${ISSUE_TITLE}" >> "$GITHUB_OUTPUT"
          echo "${ISSUE_BODY}" > /tmp/issue-body.txt

          # Detect task type (MODIFY vs CREATE)
          TASK_TYPE=$(grep -iP '\*\*Task\s+Type\*?\*?:' /tmp/issue-body.txt | head -1 | grep -oiP '(CREATE|MODIFY)' | head -1 || echo "CREATE")
          echo "task_type=${TASK_TYPE:-CREATE}" >> "$GITHUB_OUTPUT"

          # Extract parent issue number
          PARENT_NUM=$(grep -oP 'Parent\s+Issue\*?\*?:\s*#(\d+)' /tmp/issue-body.txt | grep -oP '\d+' | head -1 || echo "")
          echo "parent_issue=${PARENT_NUM}" >> "$GITHUB_OUTPUT"

      - name: Clone target repo
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          # Extract target repo from issue body (owner/repo format)
          TARGET_REPO=$(grep -iP '\*\*Target\s+Repo\*?\*?:?\*?\*?\s*' /tmp/issue-body.txt | grep -oP '[A-Za-z0-9_-]+/[a-z0-9_-]+' | head -1)
          if [ -z "$TARGET_REPO" ]; then
            # Fallback: find any owner/repo pattern in the body (after ** markers)
            TARGET_REPO=$(grep -oP '(?<=\s)[A-Za-z0-9_-]+/[a-z0-9][a-z0-9_-]+' /tmp/issue-body.txt | head -1)
          fi
          if [ -z "$TARGET_REPO" ]; then
            echo "::error::Could not find target repo in issue body"
            exit 1
          fi
          echo "TARGET_REPO=${TARGET_REPO}" >> "$GITHUB_ENV"
          gh repo clone "${TARGET_REPO}" /tmp/target-repo
          cd /tmp/target-repo
          git config user.name "Factory Bot"
          git config user.email "factory@molroo.io"

      - name: Clean up stale branch on retry
        if: github.event.label.name == 'factory:retry'
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          cd /tmp/target-repo
          # Parse branch name from issue body
          BRANCH=$(grep -iP '\*\*Branch\*?\*?:' /tmp/issue-body.txt | head -1 | grep -oP 'factory/[a-z0-9_-]+' | head -1)
          if [ -n "$BRANCH" ]; then
            echo "Cleaning up stale branch: ${BRANCH}"
            git push origin --delete "$BRANCH" 2>/dev/null || echo "Branch ${BRANCH} not on remote, OK."
            # Close stale PR if exists
            STALE_PR=$(gh pr list --repo "$TARGET_REPO" --state open --head "$BRANCH" --json number -q '.[0].number')
            if [ -n "$STALE_PR" ]; then
              gh pr close "$STALE_PR" --repo "$TARGET_REPO" --delete-branch \
                --comment "[factory:worker] Closing stale PR before retry." 2>/dev/null || true
            fi
          fi

      - name: Copy factory CLAUDE.md to target repo
        run: |
          # Make factory SDK patterns available in the target repo working directory
          cp ${{ github.workspace }}/CLAUDE.md /tmp/target-repo/.factory-claude.md

      - name: Analyze existing code (MODIFY tasks)
        if: steps.issue.outputs.task_type == 'MODIFY'
        run: |
          cd /tmp/target-repo
          echo "=== Analyzing existing codebase for modification task ==="

          # Generate file listing
          EXISTING_FILES=$(find . -type f -not -path './.git/*' -not -path './node_modules/*' -not -path './dist/*' | sort | head -80)
          echo "EXISTING_FILES<<EOF_FILES" >> "$GITHUB_ENV"
          echo "$EXISTING_FILES" >> "$GITHUB_ENV"
          echo "EOF_FILES" >> "$GITHUB_ENV"

      - name: Worker Agent â€” Implement Task
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          FACTORY_INSTRUCTIONS=$(cat /tmp/target-repo/.factory-claude.md)
          TASK_TYPE="${{ steps.issue.outputs.task_type }}"
          EXISTING_CODE="${EXISTING_FILES:-}"

          cd /tmp/target-repo

          MODIFY_INSTRUCTIONS=""
          if [ "$TASK_TYPE" = "MODIFY" ]; then
            MODIFY_INSTRUCTIONS="
          IMPORTANT: This is a MODIFY task on an existing codebase.
          - READ existing files before making changes
          - Preserve existing code style, patterns, and conventions
          - Only change what's necessary for the requirements
          - Do NOT break existing functionality
          - If you encounter a situation where you need human input to decide between approaches,
            create a decision sub-issue by running:
            gh issue create --repo \$GITHUB_REPOSITORY \\
              --title '[factory:decision] <brief question>' \\
              --label 'factory:decision' \\
              --body 'Parent: #\$PARENT_ISSUE_NUM
            <describe the decision needed, options, and trade-offs>'
            Then comment on THIS issue: '[factory:worker-blocked] Waiting for decision in #<new-issue>'
            Then EXIT (do not continue implementing).

          Existing files in repo:
          ${EXISTING_CODE}"
          fi

          claude -p "You are a Factory Worker Agent. Task issue #${{ github.event.issue.number }}.

          Issue title: ${{ steps.issue.outputs.title }}

          Issue body:
          ${ISSUE_BODY}

          Factory SDK patterns and conventions:
          ${FACTORY_INSTRUCTIONS}
          ${MODIFY_INSTRUCTIONS}

          Instructions:
          1. Read the issue body for file ownership, branch name, and requirements
          2. Create the specified branch: git checkout -b <branch>
          3. Implement ONLY the files listed in 'File Ownership'
          4. If package.json exists, run 'npm install && npm run build'
          5. git add and commit: 'feat: <task description>'
          6. Push: git push origin <branch>
          7. Create PR in the target repo: gh pr create --repo ${TARGET_REPO} --title '[factory] <task>' --body '...' --head <branch> --base main

          CRITICAL: Do NOT modify files outside your file ownership list." \
            --output-format text \
            --max-turns 30 \
            --dangerously-skip-permissions

          CLAUDE_EXIT=$?
          if [ $CLAUDE_EXIT -ne 0 ]; then
            echo "::error::Claude Code exited with code $CLAUDE_EXIT"
            exit 1
          fi

      - name: Verify PR and collect result
        id: result
        if: always()
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          BRANCH=$(grep -iP '\*\*Branch\*?\*?:' /tmp/issue-body.txt | head -1 | grep -oP 'factory/[a-z0-9_-]+' | head -1)

          if [ "${{ job.status }}" = "success" ]; then
            PR_EXISTS=$(gh pr list --repo "$TARGET_REPO" --state open --head "$BRANCH" --json number -q '.[0].number' 2>/dev/null || echo "")
            if [ -z "$PR_EXISTS" ]; then
              # Auto-create PR if worker didn't
              ISSUE_TITLE=$(gh issue view "$ISSUE_NUM" --json title -q .title)
              PR_EXISTS=$(gh pr create --repo "$TARGET_REPO" \
                --title "[factory] ${ISSUE_TITLE}" \
                --body "[factory:worker] Auto-created PR." \
                --head "$BRANCH" --base main 2>/dev/null | grep -oP '\d+$' || echo "")
            fi
            echo "pr=${PR_EXISTS}" >> "$GITHUB_OUTPUT"
          fi

      - name: Report completion (as bot)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          PR="${{ steps.result.outputs.pr }}"

          if [ "${{ job.status }}" = "success" ]; then
            if [ -n "$PR" ]; then
              gh issue comment "$ISSUE_NUM" \
                --body "<!-- factory:bot -->
          [factory:worker-report] Worker completed. PR #${PR} in ${TARGET_REPO}."
            else
              gh issue comment "$ISSUE_NUM" \
                --body "<!-- factory:bot -->
          [factory:worker-report] Worker completed with warning: PR creation failed.
          [Run log](${RUN_URL})"
            fi
            # React with rocket and close
            gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
              -f content=rocket --silent
            gh issue close "$ISSUE_NUM"

          elif [ "${{ job.status }}" = "cancelled" ]; then
            gh issue comment "$ISSUE_NUM" \
              --body "<!-- factory:bot -->
          [factory:worker-report] Worker **cancelled**.
          [Run log](${RUN_URL})"

          else
            gh issue comment "$ISSUE_NUM" \
              --body "<!-- factory:bot -->
          [factory:worker-report] Worker **failed**.

          **Action required:** Add \`factory:retry\` label to re-run, or close to skip.
          [Run log](${RUN_URL})"
            # React with confused
            gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
              -f content=confused --silent
          fi

      - name: Update labels and notify parent
        if: always()
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          PARENT_ISSUE="${{ steps.issue.outputs.parent_issue }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ job.status }}" = "success" ]; then
            if [ -n "$PARENT_ISSUE" ]; then
              gh issue comment "$PARENT_ISSUE" \
                --body "<!-- factory:bot -->
          Worker task #${ISSUE_NUM} completed. PR ready for integration." 2>/dev/null || true
            fi
          else
            if [ "${{ job.status }}" != "cancelled" ]; then
              gh label create "factory:blocked" --color D93F0B --force 2>/dev/null || true
              gh issue edit "$ISSUE_NUM" --add-label "factory:blocked"
              if [ -n "$PARENT_ISSUE" ]; then
                gh issue comment "$PARENT_ISSUE" \
                  --body "<!-- factory:bot -->
          Worker task #${ISSUE_NUM} failed. See [run log](${RUN_URL}). Add \`factory:retry\` label on #${ISSUE_NUM} to retry." 2>/dev/null || true
              fi
            fi
          fi

      - name: Check phase completion & trigger integrator
        if: success()
        env:
          GH_TOKEN: ${{ secrets.FACTORY_GH_PAT }}
        run: |
          echo "=== Checking if all workers for this phase are done ==="

          # Parse phase and spec from this issue's body
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          PHASE=$(echo "$ISSUE_BODY" | grep -iP '\*\*Phase\*?\*?:' | head -1 | sed 's/.*[*:]\s*//' | awk '{print $1}' | tr -d '`*')
          SPEC=$(echo "$ISSUE_BODY" | grep -iP '\*\*Spec\*?\*?:' | head -1 | sed 's/.*[*:]\s*//' | awk '{print $1}' | tr -d '`*')

          echo "Phase: ${PHASE}"
          echo "Spec: ${SPEC}"

          if [ -z "$PHASE" ] || [ -z "$SPEC" ]; then
            echo "::warning::Could not parse Phase or Spec from issue body. Skipping auto-trigger."
            echo "Issue body (first 500 chars):"
            head -c 500 /tmp/issue-body.txt
            exit 0
          fi

          # Get all open issues with factory:worker-task label
          ISSUE_NUMBERS=$(gh issue list --label "factory:worker-task" --state open --json number -q '.[].number')
          echo "All open worker issues: ${ISSUE_NUMBERS}"

          TOTAL_PHASE_ISSUES=0
          COMPLETED_PHASE_ISSUES=0
          BLOCKED_PHASE_ISSUES=0

          for ISSUE_NUM in $ISSUE_NUMBERS; do
            # Read issue body to check if it belongs to the same phase
            BODY=$(gh issue view "$ISSUE_NUM" --json body -q .body)
            ISSUE_PHASE=$(echo "$BODY" | grep -iP '\*\*Phase\*?\*?:' | head -1 | sed 's/.*[*:]\s*//' | awk '{print $1}' | tr -d '`*')

            if [ "$ISSUE_PHASE" != "$PHASE" ]; then
              continue
            fi

            TOTAL_PHASE_ISSUES=$((TOTAL_PHASE_ISSUES + 1))

            # Check if blocked
            LABELS=$(gh issue view "$ISSUE_NUM" --json labels -q '.labels[].name')
            if echo "$LABELS" | grep -q "factory:blocked"; then
              BLOCKED_PHASE_ISSUES=$((BLOCKED_PHASE_ISSUES + 1))
              continue
            fi

            # Check if this issue has a "Worker completed" comment
            COMPLETED=$(gh issue view "$ISSUE_NUM" --json comments -q '.comments[].body' | grep -c '\[factory:worker-report\] Worker completed' || true)
            if [ "$COMPLETED" -gt 0 ]; then
              COMPLETED_PHASE_ISSUES=$((COMPLETED_PHASE_ISSUES + 1))
            fi
          done

          echo "Phase '${PHASE}': ${COMPLETED_PHASE_ISSUES} completed, ${BLOCKED_PHASE_ISSUES} blocked, ${TOTAL_PHASE_ISSUES} total"

          if [ "$TOTAL_PHASE_ISSUES" -eq 0 ]; then
            echo "::warning::No issues found for phase '${PHASE}'"
            exit 0
          fi

          if [ "$BLOCKED_PHASE_ISSUES" -gt 0 ]; then
            echo "::warning::${BLOCKED_PHASE_ISSUES} worker(s) blocked. Cannot proceed until resolved."
            exit 0
          fi

          if [ "$COMPLETED_PHASE_ISSUES" -lt "$TOTAL_PHASE_ISSUES" ]; then
            echo "Not all workers done yet. Waiting for others."
            exit 0
          fi

          echo "=== All workers done! Triggering Integrator ==="

          # Collect PR numbers from target repo
          TARGET_REPO=$(echo "$ISSUE_BODY" | grep -iP '\*\*Target\s+Repo' | grep -oP '[A-Za-z0-9_-]+/[a-z0-9_-]+' | head -1)
          PRS=$(gh pr list --repo "$TARGET_REPO" --state open --json number,title -q '.[] | select(.title | startswith("[factory]")) | .number' | tr '\n' ',' | sed 's/,$//')
          echo "PRs to integrate: ${PRS}"

          if [ -z "$PRS" ]; then
            echo "::warning::No open factory PRs found in ${TARGET_REPO}"
            exit 0
          fi

          # Guard: check if Integrator is already running/queued for this phase
          RUNNING=$(gh run list --workflow factory-integrator.yml --status in_progress --json databaseId -q 'length')
          QUEUED=$(gh run list --workflow factory-integrator.yml --status queued --json databaseId -q 'length')
          if [ "${RUNNING:-0}" -gt 0 ] || [ "${QUEUED:-0}" -gt 0 ]; then
            echo "Integrator already running or queued. Skipping duplicate trigger."
            exit 0
          fi

          gh workflow run factory-integrator.yml \
            --field spec="$SPEC" \
            --field phase="$PHASE" \
            --field prs="$PRS"

          echo "Integrator triggered for phase=${PHASE}, prs=${PRS}"
